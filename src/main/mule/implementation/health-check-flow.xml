<?xml version="1.0" encoding="UTF-8"?>
<!-- =====================================================
     ERP Kafka Salesforce Integration - Health Check Flow
     =====================================================
     This file contains standalone health check flows:
     - Comprehensive health check
     - Individual component health checks
     - Metrics endpoint
     ===================================================== -->
<mule xmlns="http://www.mulesoft.org/schema/mule/core"
      xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
      xsi:schemaLocation="
        http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
        http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">

    <!-- =====================================================
         COMPREHENSIVE HEALTH CHECK SUBFLOW
         Checks all system dependencies
         ===================================================== -->
    <sub-flow name="comprehensive-health-check-subflow" doc:name="Comprehensive Health Check Subflow">
        <logger level="INFO" message="[HEALTH] Starting comprehensive health check" doc:name="Log Health Start"/>
        
        <!-- Initialize status variables -->
        <set-variable variableName="healthStatus" value="UP" doc:name="Init Health Status"/>
        <set-variable variableName="kafkaHealth" value="UNKNOWN" doc:name="Init Kafka Health"/>
        <set-variable variableName="salesforceHealth" value="UNKNOWN" doc:name="Init Salesforce Health"/>
        <set-variable variableName="objectStoreHealth" value="UNKNOWN" doc:name="Init ObjectStore Health"/>
        <set-variable variableName="healthDetails" value="#[{}]" doc:name="Init Health Details"/>
        
        <!-- Check Kafka -->
        <try doc:name="Check Kafka Health">
            <!-- Kafka health is verified by successful consumer config -->
            <set-variable variableName="kafkaHealth" value="UP" doc:name="Kafka UP"/>
            <error-handler>
                <on-error-continue type="ANY">
                    <set-variable variableName="kafkaHealth" value="DOWN" doc:name="Kafka DOWN"/>
                    <set-variable variableName="healthStatus" value="DEGRADED" doc:name="Set Degraded"/>
                </on-error-continue>
            </error-handler>
        </try>
        
        <!-- Check Salesforce -->
        <try doc:name="Check Salesforce Health">
            <flow-ref name="salesforce-health-check-subflow" doc:name="Check Salesforce"/>
            <set-variable variableName="salesforceHealth" value="UP" doc:name="Salesforce UP"/>
            <error-handler>
                <on-error-continue type="ANY">
                    <set-variable variableName="salesforceHealth" value="DOWN" doc:name="Salesforce DOWN"/>
                    <set-variable variableName="healthStatus" value="DEGRADED" doc:name="Set Degraded"/>
                </on-error-continue>
            </error-handler>
        </try>
        
        <!-- Check Object Store -->
        <try doc:name="Check ObjectStore Health">
            <flow-ref name="objectstore-health-check-subflow" doc:name="Check ObjectStore"/>
            <set-variable variableName="objectStoreHealth" value="UP" doc:name="ObjectStore UP"/>
            <error-handler>
                <on-error-continue type="ANY">
                    <set-variable variableName="objectStoreHealth" value="DOWN" doc:name="ObjectStore DOWN"/>
                    <!-- ObjectStore down is not critical -->
                </on-error-continue>
            </error-handler>
        </try>
        
        <!-- Build comprehensive health response -->
        <ee:transform doc:name="Build Health Response">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    status: vars.healthStatus,
    timestamp: now() as String {format: "yyyy-MM-dd'T'HH:mm:ss'Z'"},
    application: {
        name: p('app.name'),
        version: p('app.version'),
        environment: p('mule.env')
    },
    components: {
        kafka: {
            status: vars.kafkaHealth,
            bootstrapServers: p('kafka.bootstrap.servers'),
            consumerGroup: p('kafka.consumer.group.id'),
            inputTopic: p('kafka.input.topic')
        },
        salesforce: {
            status: vars.salesforceHealth,
            authUrl: p('salesforce.auth.url'),
            apiVersion: p('salesforce.api.version')
        },
        objectStore: {
            status: vars.objectStoreHealth
        }
    }
}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
        
        <logger level="INFO" 
            message='#["[HEALTH] Health check complete - Status: " ++ vars.healthStatus]'
            doc:name="Log Health Complete"/>
    </sub-flow>

    <!-- =====================================================
         OBJECT STORE HEALTH CHECK SUBFLOW
         Verifies Object Store connectivity
         ===================================================== -->
    <sub-flow name="objectstore-health-check-subflow" doc:name="ObjectStore Health Check Subflow">
        <logger level="DEBUG" message="[HEALTH] Checking ObjectStore connectivity" doc:name="Log OS Check"/>
        
        <!-- Simple store/retrieve test -->
        <try doc:name="Try ObjectStore Test">
            <os:store key="health-check-test" 
                objectStore="Idempotent_Message_Store"
                failIfPresent="false"
                doc:name="Store Test Value">
                <os:value><![CDATA[#[now() as String]]]></os:value>
            </os:store>
            
            <os:retrieve key="health-check-test" 
                objectStore="Idempotent_Message_Store" 
                target="osTestValue"
                doc:name="Retrieve Test Value">
                <os:default-value><![CDATA[#[null]]]></os:default-value>
            </os:retrieve>
            
            <logger level="DEBUG" message="[HEALTH] ObjectStore connectivity verified" doc:name="Log OS OK"/>
            
            <error-handler>
                <on-error-propagate type="ANY">
                    <logger level="WARN" 
                        message='#["[HEALTH] ObjectStore check failed - Error: " ++ error.description]'
                        doc:name="Log OS Error"/>
                </on-error-propagate>
            </error-handler>
        </try>
    </sub-flow>

</mule>
